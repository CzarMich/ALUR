---
Encounter:
  query_template: |
    SELECT DISTINCT
      c/uid/value AS composition_id, 
      e/ehr_status/subject/external_ref/id/value AS subject_id,
      c/context/other_context[at0001]/items[at0005]/value/value AS type,
      c/context/other_context[at0001]/items[at0004]/value/value AS class,
      c/context/other_context[at0001]/items[at0010]/value/value AS status,
      c/context/other_context[at0001]/items[at0010]/value/defining_code/terminology_id/value AS status_code_system,
      c/context/other_context[at0001]/items[at0010]/value/defining_code/code_string AS status_code,
      c/context/other_context[at0001]/items[at0003]/value AS fall_kennung,
      c/content[openEHR-EHR-ADMIN_ENTRY.admission.v0]/data[at0001]/items[at0071]/value AS date_of_opening,
      c/content[openEHR-EHR-ADMIN_ENTRY.admission.v0]/data[at0001]/items[at0023]/value AS date_of_admission
    FROM EHR e
    (CONTAINS COMPOSITION c[openEHR-EHR-COMPOSITION.fall.v1] AND COMPOSITION k[openEHR-EHR-COMPOSITION.report.v1])
    WHERE c/name/value = '{{composition_name}}' AND k/name/value = 'UKSH Einwilligung'
    AND (k/content[openEHR-EHR-ACTION.uksh_einwilligung.v1]/description[at0001]/items[openEHR-EHR-CLUSTER.uksh_consent.v1]/items[openEHR-EHR-CLUSTER.policy.v1]/items[at0006]/value/defining_code/code_string MATCHES {
            '1.2.276.0.76.3.1.454.1.100.1.1.1.1', 
            '1.2.276.0.76.3.1.454.1.100.1.1.2.1',
            '1.2.276.0.76.3.1.454.1.100.1.1.4.1'
        }
    )
    AND c/context/start_time/value >= '{{last_run_time}}'
    AND c/context/start_time/value < '{{end_run_time}}'
    OFFSET {{offset}} LIMIT {{limit}}
  parameters:
    composition_name: "StationÃ¤rer Versorgungsfall"
    last_run_time: "2025-01-29T00:00:00"
    offset: 0
    limit: 10
    poll_interval: 1800 # Custome polling interval for condition in 30 minutes

  mappings:
    resourceType: "Encounter"
    id: "{{composition_id}}"
    text:
      status: "generated"  # Indicates that the narrative is generated by the system
      div: >
       <div xmlns='http://www.w3.org/1999/xhtml'>
       {% if composition_id %}
       Default text for Condition notes: {{composition_id_ciphertext}}
       {% else %} No additional notes available.
       {% endif %}
       </div>
    identifier:
      - value: "{{fall_kennung}}"
    meta:
      profile:
        - "https://www.medizininformatik-initiative.de/fhir/core/modul-fall/StructureDefinition/KontaktGesundheitseinrichtung"
    status: 
      system: "{{status_code_system}}"
      code: "{{status_code}}"
      display: "{{class}}"
    class:
      system: "{{encounter_class_system}}"
      code: "{{class}}"
      display: "{{class_display}}"
    classHistory:
      - class: "{{encounter_class}}"
        period:
          start: "{{encounter_start_date}}"
          end: "{{encounter_end_date}}"
    type:
      - coding:
          - system: "{{type_system}}"
            code: "{{type}}"
            display: "{{type_display}}"
    serviceType:
      - coding:
          - system: "{{encounter_service_type_system}}"
            code: "{{encounter_service_type_code}}"
            display: "{{encounter_service_type_display}}"
    priority:
      coding:
        - system: "{{encounter_priority_system}}"
          code: "{{encounter_priority_code}}"
          display: "{{encounter_priority_display}}"
    subject:
      identifier:
        value: "{{subject_id}}"
        system: "http://local/Pseudonymised_ID"
    episodeOfCare:
      reference: "{{episode_of_care_reference}}"
      identifier:
        value: "{{episode_of_care_id}}"
    basedOn:
      reference: "{{based_on_reference}}"
      identifier:
        value: "{{based_on_id}}"
    participant:
      - type:
          - coding:
              - system: "{{participant_type_system}}"
                code: "{{participant_type_code}}"
                display: "{{participant_type_display}}"
        individual:
          reference: "{{participant_individual_reference}}"
          identifier:
            value: "{{participant_individual_id}}"
        period:
          start: "{{participant_start_date}}"
          end: "{{participant_end_date}}"
    appointment:
      reference: "{{appointment_reference}}"
      identifier:
        value: "{{appointment_id}}"
    period:
      start: "{{date_of_opening}}"
      end: "{{encounter_end_date}}"
    length:
      value: "{{encounter_length}}"
      unit: "{{encounter_length_unit}}"
    reasonCode:
      - coding:
          - system: "{{reason_code_system}}"
            code: "{{reason_code_code}}"
            display: "{{reason_code_display}}"
    diagnosis:
      - condition:
          reference: "{{diagnosis_reference}}"
          identifier:
            value: "{{diagnosis_id}}"
        use:
          coding:
            - system: "{{diagnosis_use_system}}"
              code: "{{diagnosis_use_code}}"
              display: "{{diagnosis_use_display}}"
        rank: "{{diagnosis_rank}}"
    account:
      reference: "{{account_reference}}"
      identifier:
        value: "{{account_id}}"
    hospitalization:
      preAdmissionIdentifier:
        value: "{{pre_admission_id}}"
      origin:
        reference: "{{origin_reference}}"
        identifier:
          value: "{{origin_id}}"
      admitSource:
        coding:
          - system: "{{admit_source_system}}"
            code: "{{admit_source_code}}"
            display: "{{admit_source_display}}"
      reAdmission:
        coding:
          - system: "{{readmission_system}}"
            code: "{{readmission_code}}"
            display: "{{readmission_display}}"
      dietPreference:
        coding:
          - system: "{{diet_preference_system}}"
            code: "{{diet_preference_code}}"
            display: "{{diet_preference_display}}"
      specialCourtesy:
        coding:
          - system: "{{special_courtesy_system}}"
            code: "{{special_courtesy_code}}"
            display: "{{special_courtesy_display}}"
      specialArrangement:
        coding:
          - system: "{{special_arrangement_system}}"
            code: "{{special_arrangement_code}}"
            display: "{{special_arrangement_display}}"
      destination:
        reference: "{{destination_reference}}"
        identifier:
          value: "{{destination_id}}"
      dischargeDisposition:
        coding:
          - system: "{{discharge_disposition_system}}"
            code: "{{discharge_disposition_code}}"
            display: "{{discharge_disposition_display}}"
    location:
      - location:
          reference: "{{location_reference}}"
          identifier:
            value: "{{location_id}}"
        status: "{{location_status}}"
        physicalType:
          coding:
            - system: "{{physical_type_system}}"
              code: "{{physical_type_code}}"
              display: "{{physical_type_display}}"
        period:
          start: "{{location_start_date}}"
          end: "{{location_end_date}}"
    serviceProvider:
      reference: "{{service_provider_reference}}"
      identifier:
        value: "{{service_provider_id}}"
    partOf:
      reference: "{{part_of_reference}}"
      identifier:
        value: "{{part_of_id}}"  
    # Uncomment and add more fields as needed

    