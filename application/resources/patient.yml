---
Patient:
  query_template: |
    SELECT DISTINCT
      c/uid/value AS composition_id, 
      e/ehr_status/subject/external_ref/id/value AS subject_id,
      c/content[openEHR-EHR-EVALUATION.gender.v1]/data[at0002]/items[at0022]/value/value AS administrative_gender,
      c/content[openEHR-EHR-EVALUATION.gender.v1]/data[at0002]/items[at0022]/value/defining_code/terminology_id/value AS gender_system,
      c/content[openEHR-EHR-EVALUATION.gender.v1]/data[at0002]/items[at0022]/value/defining_code/code_string AS gender_code,
      c/content[openEHR-EHR-ADMIN_ENTRY.person_data.v0]/data[at0001]/items[openEHR-EHR-CLUSTER.person_birth_data_iso.v0]/items[at0001]/value/value AS birth_date
      
    FROM EHR e
    CONTAINS (COMPOSITION c[openEHR-EHR-COMPOSITION.personendaten.v0]  AND COMPOSITION k[openEHR-EHR-COMPOSITION.report.v1])
    WHERE c/name/value = '{{composition_name}}' AND k/name/value = 'UKSH Einwilligung'
    AND (k/content[openEHR-EHR-ACTION.uksh_einwilligung.v1]/description[at0001]/items[openEHR-EHR-CLUSTER.uksh_consent.v1]/items[openEHR-EHR-CLUSTER.policy.v1]/items[at0006]/value/defining_code/code_string MATCHES {
            '1.2.276.0.76.3.1.454.1.100.1.1.1.1', 
            '1.2.276.0.76.3.1.454.1.100.1.1.2.1',
            '1.2.276.0.76.3.1.454.1.100.1.1.4.1'
        }
    )
    AND c/context/start_time/value >= '{{last_run_time}}'
    AND c/context/start_time/value < '{{end_run_time}}'
    OFFSET {{offset}} LIMIT {{limit}}
  parameters:
    composition_name: "Person"
    last_run_time: "2025-01-29T00:00:00"
    offset: 0
    limit: 10
    poll_interval: 1800 # Custome polling interval for condition in 30 minutes

  mappings:
    resourceType: "Patient"
    id: "{{composition_id}}"
    text:
      status: "generated"  # Indicates that the narrative is generated by the system
      div: >
       <div xmlns='http://www.w3.org/1999/xhtml'>
       {% if composition_id %}
       Default text for Patient notes: {{composition_id_ciphertext}}
       {% else %} No additional notes available.
       {% endif %}
       </div>
    identifier:
      - value: "{{composition_id}}"
    meta:
      profile:
        - "https://www.medizininformatik-initiative.de/fhir/core/modul-person/StructureDefinition/PatientPseudonymisiert"
    status: "active"
    name:
      - use: "official"
        family: "{{family_name}}"
        given: 
          - "{{given_name}}"
        prefix: 
          - "{{prefix}}"
        suffix: 
          - "{{suffix}}"
    telecom:
      - system: "{{telecom_system}}"
        value: "{{telecom_value}}"
        use: "{{telecom_use}}"
    gender:
      coding:
        - system: "{{gender_system}}"
          code: "{{administrative_gender}"
          display: "{{gender_code}}"
    birthDate: "{{birth_date}}"
    address:
      - use: "{{address_use}}"
        type: "{{address_type}}"
        text: "{{address_text}}"
        line: 
          - "{{address_line1}}"
          - "{{address_line2}}"
        city: "{{address_city}}"
        district: "{{address_district}}"
        state: "{{address_state}}"
        postalCode: "{{address_postal_code}}"
        country: "{{address_country}}"
    deceasedBoolean: "{{deceased_boolean}}" 
    deceasedDateTime: "{{deceased_date_time}}"
    multipleBirthBoolean: "{{multiple_birth_boolean}}"
    multipleBirthInteger: "{{multiple_birth_integer}}"
    photo:
      - url: "{{photo_url}}"
      - data: "{{photo_data}}"
    contact:
      - relationship:
          - coding:
              - system: "{{contact_relationship_system}}"
                code: "{{contact_relationship_code}}"
                display: "{{contact_relationship_display}}"
        name:
          - family: "{{contact_family_name}}"
            given: 
              - "{{contact_given_name}}"
            prefix: 
              - "{{contact_prefix}}"
            suffix: 
              - "{{contact_suffix}}"
        telecom:
          - system: "{{contact_telecom_system}}"
            value: "{{contact_telecom_value}}"
            use: "{{contact_telecom_use}}"
        address:
          - use: "{{contact_address_use}}"
            type: "{{contact_address_type}}"
            text: "{{contact_address_text}}"
            line: 
              - "{{contact_address_line1}}"
              - "{{contact_address_line2}}"
            city: "{{contact_address_city}}"
            district: "{{contact_address_district}}"
            state: "{{contact_address_state}}"
            postalCode: "{{contact_address_postal_code}}"
            country: "{{contact_address_country}}"
    generalPractitioner:
      - reference: "{{general_practitioner_reference}}"
      - identifier:
          value: "{{general_practitioner_id}}"
          system: "http://local/General_Practitioner_ID"
    managingOrganization:
      reference: "{{managing_organization_reference}}"
      identifier:
        value: "{{managing_organization_id}}"
    link:
      - other:
          reference: "{{link_other_reference}}"
          identifier:
            value: "{{link_other_id}}"
      - type: "{{link_type}}"
      - assurance: "{{link_assurance}}"
