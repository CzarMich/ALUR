---
Condition:
  query_template: |
    SELECT
      v/commit_audit/time_committed/value AS TIMECommitted,
      e/ehr_status/subject/external_ref/id/value AS subjectID,
      c/context/other_context[at0001]/items[openEHR-EHR-CLUSTER.case_identification.v0]/items[
        at0001]/value/value AS encounter_id,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[
        openEHR-EHR-CLUSTER.problem_qualifier.v2]/items[at0004]/value/value AS Condition_category,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[
        openEHR-EHR-CLUSTER.problem_qualifier.v2]/items[at0004]/value/defining_code/code_string AS 
        Condition_category_code,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0002]/value/
        defining_code/code_string AS Condition_code,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0002]/value/value 
        AS Condition_Display,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0002]/value/
        defining_code/terminology_id/value AS Condition_code_system,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0003]/value/value 
        AS Condition_recordedDate,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0012]/value/value 
        AS Condition_BodySite,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0012]/value/
        defining_code/terminology_id/value AS Condition_BodySite_code_system,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0012]/value/
        defining_code/code_string AS Condition_BodySite_code_string,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0005]/value/value 
        AS Condition_Severity_Display,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0005]/value/
        defining_code/code_string AS Condition_Severity_Code,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0005]/value/
        defining_code/terminology_id/value AS Condition_severity_system,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[
        openEHR-EHR-CLUSTER.problem_qualifier.v1]/items[at0003]/value/value AS Clinical_status,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0073]/value/value 
        AS Condition_verificationStatus,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0073]/value/
        defining_code/code_string AS Condition_verificationStatus_Code,
      c/content[openEHR-EHR-EVALUATION.problem_diagnosis.v1]/data[at0001]/items[at0073]/value/
        defining_code/terminology_id/value AS Condition_verificationStatus_System
    FROM EHR e
    CONTAINS (COMPOSITION c[openEHR-EHR-COMPOSITION.report.v1] AND COMPOSITION k[openEHR-EHR-COMPOSITION.report.v1] AND VERSION v)
    WHERE c/name/value = '{{composition_name}}' AND k/name/value = 'UKSH Einwilligung'
    AND (k/content[openEHR-EHR-ACTION.uksh_einwilligung.v1]/description[at0001]/items[openEHR-EHR-CLUSTER.uksh_consent.v1]/items[openEHR-EHR-CLUSTER.policy.v1]/items[at0006]/value/defining_code/code_string MATCHES {
            '1.2.276.0.76.3.1.454.1.100.1.1.1.1', 
            '1.2.276.0.76.3.1.454.1.100.1.1.2.1',
            '1.2.276.0.76.3.1.454.1.100.1.1.4.1'
        }
    )
    AND v/commit_audit/time_committed/value <= '{{last_run_time}}'
    OFFSET {{offset}} LIMIT {{limit}}
  parameters:
    composition_name: "Diagnose"
    last_run_time: "2025-01-29T00:00:00"
    offset: 0
    limit: 10
    poll_interval: 1800 # Custome polling interval for condition in 30 minutes

  mappings:
    resourceType: "Condition"
    id: "{{Composition_ID}}"
    text:
      status: "generated"  # Indicates that the narrative is generated by the system
      div: >
       <div xmlns='http://www.w3.org/1999/xhtml'>
       {% if BerichtID %}
       Default text for Condition notes: {{BerichtID}}
       {% else %} No additional notes available.
       {% endif %}
       </div>
    identifier:
      - value: "{{Composition_ID}}"
    meta:
      profile:
        - "https://www.medizininformatik-initiative.de/fhir/core/modul-diagnose/StructureDefinition/Diagnose"
    status: "active"
    
    category:
      coding:
        - system: "http://terminology.hl7.org/CodeSystem/condition-category"
          code: "{{Condition_category_code}}"
          display: "{{Condition_category}}"
    code:
      coding:
        - system: "{{Condition_code_system}}"
          code: "{{Condition_code}}"
          display: "{{Condition_Display}}"
          extensions:
            - url: "http://fhir.de/StructureDefinition/icd-10-gm-manifestationscode"
              valueCoding:
                system: "http://fhir.de/CodeSystem/icd-10-gm-manifestationscode"
                code: "{{Manifestation_code}}"
                display: "{{Manifestation_display}}"
            - url: "http://fhir.de/StructureDefinition/icd-10-gm-diagnosesicherheit"
              valueCoding:
                system: "https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ICD_DIAGNOSESICHERHEIT"
                code: "Condition_verificationStatus_Code"
                display: "Condition_verificationStatus"
    subject:
      reference: "Patient/{{subjectID}}"
      identifier:
        value: "{{subjectID}}"
        system: "http://USKH/Pseudonymised_ID"
    encounter:
      reference: "Encounter/{{encounter_id}}"
      identifier:
        value: "{{encounter_id}}"
        system: "http://USKH/Encounter_ID"
    recordedDate: "{{Condition_recordedDate}}"
    bodySite:
      coding:
        - system: "{{Condition_BodySite_code_system}}"
          code: "{{Condition_BodySite_code_string}}"
          display: "{{Condition_BodySite}}"
    severity:
      coding:
        - system: "{{Condition_severity_system}}"
          code: "{{Condition_Severity_Code}}"
          display: "{{Condition_Severity_Display}}"
    clinicalStatus: "{{Clinical_status}}"
    verificationStatus:
      coding:
        - system: "{{Condition_verificationStatus_System}}"
          code: "{{Condition_verificationStatus_Code}}"
          display: "{{Condition_verificationStatus}}"
    notes:
      - text: "{{note_text}}"
        time: "{{note_time}}"
    # Uncomment and add more fields as needed

    